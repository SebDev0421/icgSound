<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visualizador AudioBands API</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #0f1724; color: #eee; }
    .app { display: flex; gap: 16px; padding: 16px; }
    .sidebar { width: 220px; background: #1a2338; padding: 12px; border-radius: 8px; }
    .main { flex: 1; background: #1a2338; padding: 12px; border-radius: 8px; }
    button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 6px; width: 100%; }
    .active { background: #6ee7b7; color: #000; }
    canvas { margin-bottom: 20px; }
    input[type="date"] { width: 100%; margin-top: 6px; margin-bottom: 6px; padding: 4px; border-radius: 6px; border: none; }
    #downloadBtn { background: #3b82f6; color: white; }
     /* Popup */
    .popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .popup.active {
      display: flex;
    }
    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
        <h1>ICG Sound</h1>
        <img src="/img/logoFenoco.png" alt="ICG Logo" style="width:100%;border-radius:8px;margin-bottom:12px;" />
      <h2>Dispositivos</h2>
      <div id="devices"></div>
      <hr />
      <p>Último timestamp: <span id="lastTs">—</span></p>

      <label for="datePicker">Seleccionar día:</label>
      <input type="date" id="datePicker" />
      <button id="downloadBtn">⬇ Descargar datos</button>
    </aside>

    
    
    <main class="main">
        <h1 id="currentStation">------</h1>
      <canvas id="bandsChart"></canvas>
      <canvas id="splChart"></canvas>
    </main>

    <!-- Popup -->
    <div class="popup" id="loadingPopup">
        <div class="popup-content">
        <div class="spinner"></div>
        <p>Downloading data, please wait...</p>
        </div>
    </div>

    <footer style="position:fixed;bottom:8px;left:16px;font-size:15px;color:#555;">
      &copy; 2025 Circuit Logic SAS
  </div>

  <script>
    const btn = document.getElementById("downloadBtn");
    const dateInput = document.getElementById("dateInput");
    const popup = document.getElementById("loadingPopup");

    // === CONFIGURACIÓN ===
    const BAND_ORDER = [
      "20Hz","25Hz","31Hz5","40Hz","50Hz","63Hz","80Hz","100Hz","125Hz","160Hz","200Hz",
      "250Hz","315Hz","400Hz","500Hz","630Hz","800Hz","1kHz","1k25Hz","1k6Hz","2kHz",
      "2k5Hz","3k15Hz","4kHz","5kHz","6k3Hz","8kHz","10kHz","12k5Hz","16kHz","20kHz"
    ];
    const BAND_LABELS = [
      "20","25","31.5","40","50","63","80","100","125","160","200",
      "250","315","400","500","630","800","1k","1.25k","1.6k","2k",
      "2.5k","3.15k","4k","5k","6.3k","8k","10k","12.5k","16k","20k"
    ];

    const SPL_FIELDS = ["SPLZ","SPLC","SPLA","SPLI","SPLD","SPLT","SPLU"];

    const devicesConfig = [
      { id:"326621", name:"Aracataca", url:"/api/devices/soundmeters/lastData" },
      { id:"326583", name:"Bosconia", url:"/api/devices/soundmeters/lastData" },
      { id:"326610", name:"Fundacion", url:"/api/devices/soundmeters/lastData" },
      { id:"326614", name:"Tucurinca", url:"/api/devices/soundmeters/lastData" },
    ];
    let selectedDevice = devicesConfig[0];

    // === UI dispositivos ===
    const devDiv = document.getElementById("devices");
    devicesConfig.forEach(dev=>{
      const btn = document.createElement("button");
      btn.textContent = dev.name;
      btn.onclick = ()=> selectDevice(dev, btn);
      devDiv.appendChild(btn);
    });
    function selectDevice(dev, btn){
      selectedDevice = dev;
      [...devDiv.querySelectorAll("button")].forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }
    devDiv.querySelector("button").classList.add("active");

    // === Gráfico Bandas 1/3 octava ===
    const bandsChart = new Chart(document.getElementById("bandsChart"), {
      type:"bar",
      data:{
        labels: BAND_LABELS,
        datasets:[{
          label:"Nivel (dB)",
          data: new Array(BAND_ORDER.length).fill(-100),
          backgroundColor:"rgba(110,231,183,0.9)",
          borderRadius:4
        }]
      },
      options:{ animation:false, scales:{ y:{ suggestedMin:0, suggestedMax:120 } } }
    });

    // === Gráfico SPL ===
    const splChart = new Chart(document.getElementById("splChart"), {
      type:"bar",
      data:{
        labels:SPL_FIELDS,
        datasets:[{
          label:"SPL (dB)",
          data:new Array(SPL_FIELDS.length).fill(0),
          backgroundColor:"rgba(59,130,246,0.9)",
          borderRadius:4
        }]
      },
      options:{ animation:false, scales:{ y:{ suggestedMin:0, suggestedMax:120 } } }
    });

    // === Decodificación de bandas ===
    function decodeBands(obj) {
      return BAND_ORDER.map(b => obj[b] ?? null);
    }

    // === Fetch de datos ===
    async function fetchData(){
      if(!selectedDevice) return;
        document.getElementById("currentStation").innerText = selectedDevice.name;
      try {
        const resp = await fetch(selectedDevice.url,{
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: selectedDevice.id })
        });
        const apiData = await resp.json();

        if(Array.isArray(apiData.data) && apiData.data.length > 0){
          const row = apiData.data[0];

          // Actualizar bandas
          bandsChart.data.datasets[0].data = decodeBands(row);
          bandsChart.update();

          // Actualizar SPL
          splChart.data.datasets[0].data = SPL_FIELDS.map(f => row[f] ?? null);
          splChart.update();

          //row.register to format time stamp


          // Timestamp
          const registerStr = row.register ? row.register.toString() : null;
          document.getElementById("lastTs").innerText = formatTimestamp(registerStr)

          //detect if is online device
          Date.now() - new Date(formatTimestamp(registerStr)).getTime() < 2016000
            ? document.getElementById("lastTs").style.color = "lightgreen"
            : document.getElementById("lastTs").style.color = "red";
        }
      } catch(e){
        console.error("Error fetch:", e);
      }
    }

    setInterval(fetchData, 1000); // cada segundo



    document.getElementById("downloadBtn").addEventListener("click", async ()=>{
        await handleDownload();
    });


    function formatTimestamp(ts) {
        
        const year = ts.slice(0, 4);
        const month = ts.slice(4, 6);
        const day = ts.slice(6, 8);
        const hour = ts.slice(8, 10);
        const minute = ts.slice(10, 12);
        const second = ts.slice(12, 14);

        return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    }

    async function handleDownload() {
            const date = document.getElementById("datePicker").value;
            if (!date) return;

            popup.classList.add("active"); // mostrar popup
            btn.disabled = true;

            try {
                const resp = await fetch(selectedDevice.url.replace("lastData","dayData"),{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ id:selectedDevice.id, date:date })
                });
                const data = await resp.json();
                console.log("Data to download:", data);
                // Exportar a CSV
                let csv = Object.keys(data.data[0]).join(",") + "\n";
                data.data.forEach(row=>{
                csv += Object.values(row).join(",") + "\n";
                });

                const blob = new Blob([csv], { type:"text/csv" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `device_${selectedDevice.id}_Station_${selectedDevice.name}_${date}.csv`;
                link.click();
            } catch(e){
                console.error("Error download:", e);
            } finally {
                popup.classList.remove("active"); // ocultar popup
                btn.disabled = false;
            }
    }
  </script>
</body>
</html>
