<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visualizador AudioBands API</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #0f1724; color: #eee; }
    .app { display: flex; gap: 16px; padding: 16px; }
    .sidebar { width: 220px; background: #1a2338; padding: 12px; border-radius: 8px; }
    .main { flex: 1; background: #1a2338; padding: 12px; border-radius: 8px; }
    button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 6px; width: 100%; }
    .active { background: #6ee7b7; color: #000; }
    canvas { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h2>Dispositivos</h2>
      <div id="devices"></div>
      <hr />
      <p>Último timestamp: <span id="lastTs">—</span></p>
    </aside>
    
    <main class="main">
      <canvas id="bandsChart"></canvas>
      <canvas id="splChart"></canvas>
    </main>
  </div>

  <script>
    // === CONFIGURACIÓN ===
    const BAND_ORDER = [
      "20Hz","25Hz","31Hz5","40Hz","50Hz","63Hz","80Hz","100Hz","125Hz","160Hz","200Hz",
      "250Hz","315Hz","400Hz","500Hz","630Hz","800Hz","1kHz","1k25Hz","1k6Hz","2kHz",
      "2k5Hz","3k15Hz","4kHz","5kHz","6k3Hz","8kHz","10kHz","12k5Hz","16kHz","20kHz"
    ];
    const BAND_LABELS = [
      "20","25","31.5","40","50","63","80","100","125","160","200",
      "250","315","400","500","630","800","1k","1.25k","1.6k","2k",
      "2.5k","3.15k","4k","5k","6.3k","8k","10k","12.5k","16k","20k"
    ];

    const SPL_FIELDS = ["SPLZ","SPLC","SPLA","SPLI","SPLD","SPLT","SPLU"];

    const devicesConfig = [
      { id:"326621", name:"Aracataca", url:"/api/devices/soundmeters/lastData" },
      { id:"326583", name:"Bosconia", url:"/api/devices/soundmeters/lastData" },
      { id:"326610", name:"Fundacion", url:"/api/devices/soundmeters/lastData" },
      { id:"326614", name:"Tucurinca", url:"/api/devices/soundmeters/lastData" },
    ];
    let selectedDevice = devicesConfig[0];

    // === UI dispositivos ===
    const devDiv = document.getElementById("devices");
    devicesConfig.forEach(dev=>{
      const btn = document.createElement("button");
      btn.textContent = dev.name;
      btn.onclick = ()=> selectDevice(dev, btn);
      devDiv.appendChild(btn);
    });
    function selectDevice(dev, btn){
      selectedDevice = dev;
      [...devDiv.querySelectorAll("button")].forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }
    devDiv.querySelector("button").classList.add("active");

    // === Gráfico Bandas 1/3 octava ===
    const bandsChart = new Chart(document.getElementById("bandsChart"), {
      type:"bar",
      data:{
        labels: BAND_LABELS,
        datasets:[{
          label:"Nivel (dB)",
          data: new Array(BAND_ORDER.length).fill(-100),
          backgroundColor:"rgba(110,231,183,0.9)",
          borderRadius:4
        }]
      },
      options:{ animation:false, scales:{ y:{ suggestedMin:0, suggestedMax:120 } } }
    });

    // === Gráfico SPL ===
    const splChart = new Chart(document.getElementById("splChart"), {
      type:"bar",
      data:{
        labels:SPL_FIELDS,
        datasets:[{
          label:"SPL (dB)",
          data:new Array(SPL_FIELDS.length).fill(0),
          backgroundColor:"rgba(59,130,246,0.9)",
          borderRadius:4
        }]
      },
      options:{ animation:false, scales:{ y:{ suggestedMin:0, suggestedMax:120 } } }
    });

    // === Decodificación de bandas ===
    function decodeBands(obj) {
      return BAND_ORDER.map(b => obj[b] ?? null);
    }

    // === Fetch de datos ===
    async function fetchData(){
      if(!selectedDevice) return;
      try {
        const resp = await fetch(selectedDevice.url,{
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: selectedDevice.id })
        });
        const apiData = await resp.json();

        if(Array.isArray(apiData.data) && apiData.data.length > 0){
          const row = apiData.data[0];

          // Actualizar bandas
          bandsChart.data.datasets[0].data = decodeBands(row);
          bandsChart.update();

          // Actualizar SPL
          splChart.data.datasets[0].data = SPL_FIELDS.map(f => row[f] ?? null);
          splChart.update();

          // Timestamp
          document.getElementById("lastTs").innerText =
            row.register ? new Date(row.register).toLocaleString() : "—";
        }
      } catch(e){
        console.error("Error fetch:", e);
      }
    }

    setInterval(fetchData, 1000); // cada segundo
  </script>
</body>
</html>
